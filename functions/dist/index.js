!function(e,t){for(var r in t)e[r]=t[r]}(this,function(e){var t={};function r(o){if(t[o])return t[o].exports;var n=t[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=e,r.c=t,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(o,n,function(t){return e[t]}.bind(null,n));return o},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=14)}([function(e,t){e.exports=require("firebase-functions")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=r(0),n=r(16);t.adminDB=n.initializeApp(Object.assign({},o.config().firebase,{databaseAuthVariableOverride:"admin"})),t.firestoreDB=t.adminDB.firestore()},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=r(18);t.SocialError=o.SocialError;const n=r(19);t.BaseDomain=n.BaseDomain;const s=r(20);t.Feed=s.Feed},function(e,t){e.exports=require("express")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.Accepted=202]="Accepted",e[e.Ambiguous=300]="Ambiguous",e[e.BadGateway=502]="BadGateway",e[e.BadRequest=400]="BadRequest",e[e.Conflict=409]="Conflict",e[e.Continue=100]="Continue",e[e.Created=201]="Created",e[e.ExpectationFailed=417]="ExpectationFailed",e[e.Forbidden=403]="Forbidden",e[e.Found=302]="Found",e[e.GatewayTimeout=504]="GatewayTimeout",e[e.Gone=410]="Gone",e[e.HttpVersionNotSupported=505]="HttpVersionNotSupported",e[e.InternalServerError=500]="InternalServerError",e[e.LengthRequired=411]="LengthRequired",e[e.MethodNotAllowed=405]="MethodNotAllowed",e[e.Moved=301]="Moved",e[e.MovedPermanently=301]="MovedPermanently",e[e.MultipleChoices=300]="MultipleChoices",e[e.NoContent=204]="NoContent",e[e.NonAuthoritativeInformation=203]="NonAuthoritativeInformation",e[e.NotAcceptable=406]="NotAcceptable",e[e.NotFound=404]="NotFound",e[e.NotImplemented=501]="NotImplemented",e[e.NotModified=304]="NotModified",e[e.OK=200]="OK",e[e.PartialContent=206]="PartialContent",e[e.PaymentRequired=402]="PaymentRequired",e[e.PreconditionFailed=412]="PreconditionFailed",e[e.ProxyAuthenticationRequired=407]="ProxyAuthenticationRequired",e[e.Redirect=302]="Redirect",e[e.RedirectKeepVerb=307]="RedirectKeepVerb",e[e.RedirectMethod=303]="RedirectMethod",e[e.RequestedRangeNotSatisfiable=416]="RequestedRangeNotSatisfiable",e[e.RequestEntityTooLarge=413]="RequestEntityTooLarge",e[e.RequestTimeout=408]="RequestTimeout",e[e.RequestUriTooLong=414]="RequestUriTooLong",e[e.ResetContent=205]="ResetContent",e[e.SeeOther=303]="SeeOther",e[e.ServiceUnavailable=503]="ServiceUnavailable",e[e.SwitchingProtocols=101]="SwitchingProtocols",e[e.TemporaryRedirect=307]="TemporaryRedirect",e[e.Unauthorized=401]="Unauthorized",e[e.UnsupportedMediaType=415]="UnsupportedMediaType",e[e.Unused=306]="Unused",e[e.UpgradeRequired=426]="UpgradeRequired",e[e.UseProxy=305]="UseProxy"}(t.HttpStatusCode||(t.HttpStatusCode={}))},function(e,t){e.exports=require("moment")},function(e,t){e.exports=require("body-parser")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Verification=class{constructor(e,t,r,o,n,s,i=!1){this.id=e,this.code=t,this.target=r,this.creationDate=o,this.remoteIpAddress=n,this.userId=s,this.isVerified=i}}},function(e,t){e.exports=require("request")},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("bcrypt")},function(e,t){e.exports=require("cors")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=r(0),n=r(23),s=o.config().gmail.email,i=o.config().gmail.password,a=n.createTransport({service:"gmail",auth:{user:s,pass:i}});t.emailAPI={sendEmail:e=>new Promise((t,r)=>{const o={from:e.from,to:e.to,subject:e.subject,html:e.html};a.sendMail(o).then(()=>{console.log(`New subscription confirmation email sent to: ${e.to}`),t()}).catch(e=>{console.error("There was an error while sending the email:",e),r(e)})})}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Email=class{constructor(e,t,r,o,n){this.from=e,this.to=t,this.subject=r,this.html=o,this.text=n}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=r(15);t.onUserCreate=o.onUserCreate,t.auth=o.auth;var n=r(22);t.publicAuth=n.publicAuth;var s=r(24);t.users=s.users,t.onUpdateUserInfo=s.onUpdateUserInfo;var i=r(25);t.onCreateFeedback=i.onCreateFeedback;var a=r(26);t.onAddComment=a.onAddComment,t.onDeleteComment=a.onDeleteComment},function(e,t,r){"use strict";var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))(function(n,s){function i(e){try{c(o.next(e))}catch(e){s(e)}}function a(e){try{c(o.throw(e))}catch(e){s(e)}}function c(e){e.done?n(e.value):new r(function(t){t(e.value)}).then(i,a)}c((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),s=r(1),i=r(17),a=r(5),c=r(3),d=r(6),u=r(2),l=r(7),p=r(4),f=r(21),h=r(8),m=r(9)(),v=r(10),g=n.config().setting.appname;t.onUserCreate=n.auth.user().onCreate((e,t)=>new Promise((t,r)=>{const o=e,n=new i.Circle;return n.creationDate=a().unix(),n.name="Following",n.ownerId=o.uid,n.isSystem=!0,s.firestoreDB.collection("users").doc(o.uid).collection("circles").add(Object.assign({},n)).then(e=>{t()}).catch(r)}));const S=c(),y=r(11)({origin:!0});S.disable("x-powered-by"),S.use(y),S.use(d.json()),S.use(m),S.use((e,t,r)=>{if(console.log("Check if request is authorized with Firebase ID token"),!(e.headers.authorization&&e.headers.authorization.startsWith("Bearer ")||e.cookies.__session))return console.error("No Firebase ID token was passed as a Bearer token in the Authorization header.","Make sure you authorize your request by providing the following HTTP header:","Authorization: Bearer <Firebase ID Token>",'or by passing a "__session" cookie.'),void t.status(p.HttpStatusCode.Forbidden).send(new u.SocialError("ServerError/Unauthorized","User is Unauthorized!"));let o;e.headers.authorization&&e.headers.authorization.startsWith("Bearer ")?(console.log('Found "Authorization" header'),o=e.headers.authorization.split("Bearer ")[1]):(console.log('Found "__session" cookie'),o=e.cookies.__session),s.adminDB.auth().verifyIdToken(o).then(t=>(console.log("ID Token correctly decoded",t),e.user=t,r())).catch(e=>{console.error("Error while verifying Firebase ID token:",e),t.status(p.HttpStatusCode.Forbidden).send(new u.SocialError("ServerError/Unauthorized","User is Unauthorized!"))})}),S.post("/api/sms-verification",(e,t)=>o(this,void 0,void 0,function*(){const r=e.connection.remoteAddress,o=e.body["g-recaptcha-response"],i=Math.floor(1e3+9e3*Math.random()),c=e.body.phoneNumber,d=`Verification code from ${g} : <CODE>`,m=n.config().recaptcha.secretkey,v=e.user.uid;if(void 0===o||""===o||null===o)return t.json(new u.SocialError("ServerError/NullCaptchaValue","Please select captcha first"));h("https://www.google.com/recaptcha/api/siteverify?secret="+m+"&response="+o+"&remoteip="+r,(e,o,h)=>{void 0===(h=JSON.parse(h)).success||h.success||(console.log("Captha/responseError",e),console.log("Captha/responseError",o),console.log("Captha/responseError",h),t.status(p.HttpStatusCode.BadRequest).json(new u.SocialError("ServerError/ResponseCaptchaError","Failed captcha verification"))),console.log("Captha/responseSuccess"),new f.Client(n.config().plivo.authid,n.config().plivo.authtoken).messages.create("+111111",c,d.replace("<CODE>",String(i))).then(e=>{const o=s.firestoreDB.collection("verification").doc(v).collection("phone").doc(),n=new l.Verification(o.id,String(i),c,a().unix(),r,v);return o.set(Object.assign({},n)),t.status(p.HttpStatusCode.OK).json({verifyId:o.id})})})})),S.post("/api/verify-phone",(e,t)=>o(this,void 0,void 0,function*(){const r=e.connection.remoteAddress,o=e.body.code,n=e.body.verifyId,i=e.body.phoneNumber,a=e.user.uid;return s.firestoreDB.collection("verification").doc(a).collection("phone").doc(n).get().then(n=>{const c=n.data();if(console.log(c,e.body,!c.isVerified,r===c.remoteIpAddress,i===c.target,a===c.userId),c.isVerified||r!==c.remoteIpAddress||i!==c.target||a!==c.userId)t.status(p.HttpStatusCode.Forbidden).send(new u.SocialError("ServerError/Unauthorized","User is Unauthorized!"));else if(Number(c.code)===Number(o)){const e=s.firestoreDB.batch();e.update(n.ref,{isVerified:!0});const r=s.firestoreDB.collection("protectedUser").doc(a);e.update(r,{phoneVerified:!0}),e.commit().then(()=>{console.log("ServerSuccess/CodeAccepted","CodeAccepted");s.adminDB.auth().createCustomToken(a,{phoneVerified:!0}).then(e=>t.status(p.HttpStatusCode.OK).json({token:e})).catch(e=>{console.log("Error creating custom token:",e)})}).catch(e=>{console.log("ServerError/CanUpdateState",e),t.json(new u.SocialError("ServerError/CanUpdateState","Can not update user state!"))})}else t.status(p.HttpStatusCode.Forbidden).json(new u.SocialError("ServerError/WrongCode","The code is not correct!"))}).catch(e=>(console.log("ServerError/VerifyIdNotAccept",e),t.json(new u.SocialError("ServerError/VerifyIdNotAccept","We coudn't for you verification!"))))})),S.post("/api/register",(e,t)=>o(this,void 0,void 0,function*(){e.connection.remoteAddress;const r=e.body.userName,o=e.body.password,n=e.body.email,i=e.body.fullName,c=e.body.avatar,d=e.user.uid;s.firestoreDB.doc(`userInfo/${d}`).set({id:d,state:"active",avatar:c,fullName:i,creationDate:a().unix(),email:n}).then(()=>{v.hash(o,10,function(e,o){s.firestoreDB.collection("protectedUser").doc(d).set({userName:r,password:o,phoneVerified:!1}).then(()=>t.status(p.HttpStatusCode.OK).json({})).catch(e=>{t.status(p.HttpStatusCode.InternalServerError).send(new u.SocialError("ServerError/NotStoreProtectedUser","Can not store protected user!"))})})}).catch(e=>{t.status(p.HttpStatusCode.InternalServerError).send(new u.SocialError("ServerError/NotStoreUserInfo","Can not store user info!"))})})),S.post("/api/update-password",(e,t)=>o(this,void 0,void 0,function*(){e.connection.remoteAddress;const r=e.body.newPassword,o=e.body.confirmPassword,n=e.user.uid;console.log("userID: ",n),r&&o&&""!==r.trim()&&""!==o.trim()&&o===r?s.adminDB.auth().updateUser(n,{password:r}).then(e=>{v.hash(r,10,function(e,r){s.firestoreDB.collection("protectedUser").doc(n).update({password:r}).then(()=>t.status(p.HttpStatusCode.OK).json({})).catch(e=>{console.log("ServerError/NotStoreProtectedUser",e),t.status(p.HttpStatusCode.InternalServerError).send(new u.SocialError("ServerError/NotStoreProtectedUser","Can not store protected user!"))})})}).catch(e=>{console.log("UpdateUser/Password",e),t.status(p.HttpStatusCode.InternalServerError).send(new u.SocialError("ServerError/ErrorUpdateUser","Can not update user!"))}):t.status(p.HttpStatusCode.InternalServerError).send(new u.SocialError("ServerError/NotEqualConfirmNewPassword","Confirm password and new password are not equal!"))})),t.auth=n.https.onRequest(S)},function(e,t){e.exports=require("firebase-admin")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=r(2);t.Circle=class extends o.BaseDomain{}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.SocialError=class extends Error{constructor(e,t){super(t),this._code=e,this._message=t,this._isError=!0}get code(){return this._code}get message(){return this._message}get isError(){return this._isError}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.BaseDomain=class{}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Feed=class{constructor(e,t,r,o){this.id=e,this.text=t,this.feedType=r,this.user=o}}},function(e,t){e.exports=require("plivo")},function(e,t,r){"use strict";var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))(function(n,s){function i(e){try{c(o.next(e))}catch(e){s(e)}}function a(e){try{c(o.throw(e))}catch(e){s(e)}}function c(e){e.done?n(e.value):new r(function(t){t(e.value)}).then(i,a)}c((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),s=r(1),i=r(5),a=r(3),c=r(6),d=r(2),u=r(7),l=r(12),p=r(13),f=r(4),h=r(10),m=r(8),v=r(9)(),g=a(),S=r(11)({origin:!0});g.disable("x-powered-by"),g.use(S),g.use(c.json()),g.use(v);const y=n.config().gmail.email,b=n.config().setting.appname;g.post("/api/login",(e,t)=>o(this,void 0,void 0,function*(){e.connection.remoteAddress;const r=e.body.userName,o=e.body.password;console.log(r,o),s.firestoreDB.collection("protectedUser").where("userName","==",r).get().then(e=>{if(console.log("result",e.size,e.empty),!e||e.empty||1!==e.size)return t.status(f.HttpStatusCode.InternalServerError).send(new d.SocialError("ServerError/WrongUserName","User name is wrong!"));{const r=e.docs[0];console.log(r);const n=r.data();console.log("data = ",n),h.compare(o,n.password,(e,o)=>{if(!0!==o)return t.status(f.HttpStatusCode.InternalServerError).send(new d.SocialError("ServerError/WrongPassword","Password is wrong!"));{const e={phoneVerified:n.phoneVerified,userName:n.userName};s.adminDB.auth().createCustomToken(r.id,e).then(e=>t.status(f.HttpStatusCode.OK).json({token:e})).catch(e=>(console.log("Error creating custom token:",e),t.status(f.HttpStatusCode.InternalServerError).send(new d.SocialError("ServerError/CreateToke","Error on creating token!"))))}})}}).catch(e=>t.status(f.HttpStatusCode.InternalServerError).send(new d.SocialError("ServerError/FirestoreGetData",e)))})),g.post("/api/verify-email",(e,t)=>o(this,void 0,void 0,function*(){const r=e.connection.remoteAddress,o=e.body.code,n=e.body.verifyId,i=e.body.email;s.firestoreDB.collection("userInfo").where("email","==",i).get().then(a=>{if(console.log("userInfo",a.size,a.empty),a&&!a.empty&&1===a.size){const c=a.docs[0],u=c.id;console.log(c);const l=c.data();return console.log("data = ",l),s.firestoreDB.collection("verification").doc(u).collection("resetPassword").doc(n).get().then(n=>{const a=n.data();console.log(a,e.body,!a.isVerified,r===a.remoteIpAddress,i===a.target,u===a.userId),a.isVerified||r!==a.remoteIpAddress||i!==a.target||u!==a.userId?t.status(f.HttpStatusCode.Forbidden).send(new d.SocialError("ServerError/Unauthorized","User is Unauthorized!")):Number(a.code)===Number(o)?s.firestoreDB.collection("protectedUser").doc(u).get().then(e=>{let r=!1;e.exists&&e.data().phoneVerified&&(r=!0),console.log("ServerSuccess/CodeAccepted","CodeAccepted",r);const o={phoneVerified:r,userName:l.email,resetPasswordVerified:!0};s.adminDB.auth().createCustomToken(u,o).then(e=>t.status(f.HttpStatusCode.OK).json({token:e})).catch(e=>{console.log("Error creating custom token:",e),t.status(f.HttpStatusCode.InternalServerError).json(new d.SocialError("ServerError/CreateCustomToken","Create custom token error!"))})}):t.status(f.HttpStatusCode.Forbidden).json(new d.SocialError("ServerError/WrongCode","The code is not correct!"))}).catch(e=>(console.log("ServerError/VerifyIdNotAccept",e),t.json(new d.SocialError("ServerError/VerifyIdNotAccept","We coudn't for you verification!"))))}t.status(f.HttpStatusCode.NotFound).send(new d.SocialError("ServerError/EmailNotFound","Email not found!"))}).catch(e=>{t.status(f.HttpStatusCode.NotFound).send(new d.SocialError("ServerError/EmailNotFound","Email not found!"))})})),g.post("/api/email-verification-code",(e,t)=>o(this,void 0,void 0,function*(){const r=e.connection.remoteAddress,o=e.body["g-recaptcha-response"],a=Math.floor(1e3+9e3*Math.random()),c=e.body.email,h=n.config().recaptcha.secretkey,v=`${b} Reset Password <${y}>`,g=c,S=`Reset your password for ${b}`;s.firestoreDB.collection("userInfo").where("email","==",c).get().then(e=>{if(1===e.size){const n=e.docs[0].data(),y=e.docs[0].id,w=`\n                <html xmlns="http://www.w3.org/1999/xhtml">\n\n                <body>\n                <div>\n                    <h4>Hello ${n.fullName},</h4>\n\n                    <p>Enter verification code in your reset password page to reset your ${b} password for your ${c} account.</p>\n\n                    <h3>Verification Code: ${a}</h3>\n\n                    <p>If you didn’t ask to reset your password, you can ignore this email.</p>\n\n                    <h4>Thanks,</h4>\n\n                    <h4>Your ${b} team</h4>\n                </div>\n                </body>\n                </html>\n                        `;if(void 0===o||""===o||null===o)return t.json(new d.SocialError("ServerError/NullCaptchaValue","Please select captcha first"));m("https://www.google.com/recaptcha/api/siteverify?secret="+h+"&response="+o+"&remoteip="+r,(e,o,n)=>{if(void 0!==(n=JSON.parse(n)).success&&!n.success)return console.log("Captha/responseError",e),t.json(new d.SocialError("ServerError/ResponseCaptchaError","Failed captcha verification"));console.log("Captha/responseSuccess"),l.emailAPI.sendEmail(new p.Email(v,g,S,w)).then(function(e){const o=s.firestoreDB.collection("verification").doc(y).collection("resetPassword").doc(),n=new u.Verification(o.id,String(a),c,i().unix(),r,y);return o.set(Object.assign({},n)),t.status(f.HttpStatusCode.OK).json({verifyId:o.id})}).catch(e=>{t.status(f.HttpStatusCode.ServiceUnavailable).send(new d.SocialError("ServerError/EmailNotSent","Email service error. Email has not sent!"))})})}else t.status(f.HttpStatusCode.NotFound).send(new d.SocialError("ServerError/EmailNotFound","Email not found!"))}).catch(e=>{t.status(f.HttpStatusCode.NotFound).send(new d.SocialError("ServerError/EmailNotFound","With DB error. Email not found!"))})})),t.publicAuth=n.https.onRequest(g)},function(e,t){e.exports=require("nodemailer")},function(e,t,r){"use strict";var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))(function(n,s){function i(e){try{c(o.next(e))}catch(e){s(e)}}function a(e){try{c(o.throw(e))}catch(e){s(e)}}function c(e){e.done?n(e.value):new r(function(t){t(e.value)}).then(i,a)}c((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),s=r(1),i=r(3),a=r(4),c=r(2),d=i();d.disable("x-powered-by");const u=e=>o(this,void 0,void 0,function*(){return new Promise((t,r)=>{let o={};e&&e.length>0&&(e.forEach(e=>{s.firestoreDB.collection("userInfo").doc(e).get().then(t=>{let r=t.data();o=Object.assign({},o,{[e]:Object.assign({},r)})}).catch(r)}),t(o))})});d.post("/",(e,t)=>o(this,void 0,void 0,function*(){const r=JSON.parse(e.body);if(!(r&&Array.isArray(r)&&r.length>0))return t.status(a.HttpStatusCode.BadRequest).send(new c.SocialError("UserService/UserIdListNotValid",`\n        User list is undefined or not array or the length of array is not grater than zero!\n        ${JSON.stringify(r)}\n        `));u(r).then(e=>{t.status(a.HttpStatusCode.OK).send(e)})})),t.users=n.https.onRequest(d),t.onUpdateUserInfo=n.firestore.document("userInfo/{userId}").onUpdate((e,t)=>new Promise((r,o)=>{const n=t.params.userId,i=e.before.data(),a=e.after.data();if(i.avatar===a.avatar&&i.fullName===a.fullName)r();else{const e=s.firestoreDB.collection("posts").where("ownerUserId","==",n),t=s.firestoreDB.collection("comments").where("userId","==",n),i=s.firestoreDB.collection("graphs:users").where("leftNode","==",n),d=s.firestoreDB.collection("graphs:users").where("rightNode","==",n);var c=s.firestoreDB.batch();e.get().then(e=>{t.get().then(t=>{i.get().then(n=>{d.get().then(s=>{e.forEach(e=>{const t=e.data();t.ownerAvatar=a.avatar,t.ownerDisplayName=a.fullName,c.update(e.ref,t)}),t.forEach(e=>{const t=e.data();t.userDisplayName=a.avatar,t.userDisplayName=a.fullName,c.update(e.ref,t)}),n.forEach(e=>{const t=e.data(),r=t.LeftMetadata;r.avatar=a.avatar,r.fullName=a.fullName,t.LeftMetadata=r,c.update(e.ref,t)}),s.forEach(e=>{const t=e.data(),r=t.rightMetadata;r.avatar=a.avatar,r.fullName=a.fullName,t.rightMetadata=r,c.update(e.ref,t)}),c.commit().then(()=>{r()}).catch(o)})})})})}}))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=r(0),n=r(12),s=r(13),i=o.config().gmail.email,a=o.config().setting.appname;t.onCreateFeedback=o.firestore.document("feeds/{feedId}").onCreate((e,t)=>new Promise((t,r)=>{const o=e.data(),c=`${a} Feedback <${i}>`,d=`${o.feedType} -${o.user.email} - ${e.createTime}`,u=`\n    Feedback type: ${o.feedType}\n    Feedback ID: ${o.id}\n  \n    User Email: ${o.user.email}\n    User Fullname: ${o.user.fullName}\n    User ID: ${o.user.userId}\n  \n    Feedback: ${o.text}\n    `;n.emailAPI.sendEmail(new s.Email(c,"amir.gholzam@gmail.com",d,u)).then(()=>{t()}).catch(e=>{r()})}))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=r(0),n=r(1),s=r(27);t.onAddComment=o.firestore.document("comments/{commentId}").onCreate((e,t)=>{var r=e.data();const o=t.params.commentId;if(r){const e=n.firestoreDB.doc(`posts/${r.postId}`);r.postId;return n.firestoreDB.runTransaction(t=>t.get(e).then(n=>{if(n.exists){const i=n.data(),a=i.commentCounter+1;t.update(e,{commentCounter:a});let c=i.comments;if(c||(c={}),a<4)t.update(e,{comments:Object.assign({},c,{[o]:r})});else{let n=Object.assign({},c,{[o]:r});n=s.fromPairs(s.toPairs(n).sort((e,t)=>parseInt(t[1].creationDate,10)-parseInt(e[1].creationDate,10)).slice(0,3)),t.update(e,{comments:Object.assign({},n)})}}}))}}),t.onDeleteComment=o.firestore.document("comments/{commentId}").onDelete((e,t)=>new Promise((r,o)=>{const s=e.data(),i=(t.params.commentId,s.postId),a=n.firestoreDB.doc(`posts/${i}`);n.firestoreDB.collection("comments").where("postId","==",i).orderBy("creationDate","desc").get().then(e=>{let t={},o=0;e.forEach(e=>{if(o<3){const r=e.data();r.id=e.id,t=Object.assign({},t,{[e.id]:Object.assign({},r)})}o++}),a.update({comments:t,commentCounter:e.size}).then(()=>{r()})}).catch(o)}))},function(e,t){e.exports=require("lodash")}]));